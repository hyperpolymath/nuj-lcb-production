#!/bin/bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# Pre-commit hook for nuj-lcb-production

set -e

echo "Running pre-commit checks..."

# Check for SPDX headers in workflow files
if git diff --cached --name-only | grep -q "^.github/workflows/.*\.ya?ml$"; then
  echo "Checking workflow files for SPDX headers..."
  for file in $(git diff --cached --name-only | grep "^.github/workflows/.*\.ya?ml$"); do
    if [ -f "$file" ]; then
      if ! head -1 "$file" | grep -q "SPDX-License-Identifier:"; then
        echo "❌ Missing SPDX header: $file"
        echo "Add as first line: # SPDX-License-Identifier: AGPL-3.0-or-later"
        exit 1
      fi
    fi
  done
fi

# Check for secrets or sensitive data
echo "Scanning for potential secrets..."
if git diff --cached | grep -iE "(password|secret|api[_-]?key|token|private[_-]?key)" | grep -v "SPDX-License-Identifier"; then
  echo "⚠️  Warning: Found potential secrets in staged files"
  echo "Please review the above matches carefully"
  read -p "Continue with commit? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Validate EditorConfig if present
if [ -f .editorconfig ]; then
  echo "✓ EditorConfig present"
fi

echo "✅ Pre-commit checks passed"
exit 0
